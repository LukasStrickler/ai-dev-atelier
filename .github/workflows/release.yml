name: Release

# MANUAL TRIGGER ONLY - Never auto-release
# Releases are created by running: gh workflow run release.yml -f version=X.Y.Z
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (SemVer: 0.2.0, 1.0.0-beta.1)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release (beta, rc, etc.)"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Dry run (validate only, no release)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag: ${{ steps.validate.outputs.tag }}
      previous_tag: ${{ steps.previous.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          
          # Validate SemVer format (https://semver.org)
          SEMVER_RE='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$'
          if ! [[ "$VERSION" =~ $SEMVER_RE ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Use SemVer format: 1.0.0, 0.2.0-beta.1, 1.0.0-rc.1"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version format valid: $VERSION"

      - name: Check tag availability
        run: |
          TAG="v${{ inputs.version }}"
          if git show-ref --tags --verify --quiet "refs/tags/$TAG"; then
            echo "::error::Tag $TAG already exists locally!"
            echo "Choose a different version or delete the existing tag first."
            exit 1
          fi
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "::error::Remote tag $TAG already exists!"
            echo "Choose a different version or delete the existing tag first."
            exit 1
          fi
          echo "âœ… Tag v${{ inputs.version }} is available"

      - name: Get previous tag
        id: previous
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          if [ -n "$PREV_TAG" ]; then
            echo "ðŸ“‹ Previous release: $PREV_TAG"
            echo "ðŸ“ Changes since $PREV_TAG:"
            git log "${PREV_TAG}..HEAD" --oneline | head -20
          else
            echo "ðŸ“‹ This will be the first release"
            echo "ðŸ“ All commits:"
            git log --oneline | head -20
          fi

      - name: Summary
        run: |
          PREV_TAG="${{ steps.previous.outputs.tag }}"
          [ -z "$PREV_TAG" ] && PREV_TAG="none"
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`v${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-release | ${{ inputs.prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Previous | \`$PREV_TAG\` |" >> $GITHUB_STEP_SUMMARY

  release:
    name: Create Release
    needs: validate
    if: ${{ inputs.dry_run == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure running on main
        run: |
          if [ "${{ github.ref_name }}" != "main" ]; then
            echo "::error::Releases must be run from main (got: ${{ github.ref_name }})"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}" || {
            echo "::error::Failed to create tag"
            exit 1
          }
          git push origin "v${{ inputs.version }}" || {
            echo "::error::Failed to push tag"
            git tag -d "v${{ inputs.version }}" 2>/dev/null || true
            exit 1
          }
          echo "âœ… Created and pushed tag v${{ inputs.version }}"

      - name: Generate release body
        id: body
        shell: bash
        run: |
          printf '%s\n\n## Installation\n\n' >> release-body.md
          printf '\`\`\`bash\n' >> release-body.md
          printf '# Clone and install\n' >> release-body.md
          printf 'git clone https://github.com/%s.git ~/ai-dev-atelier\n' "${{ github.repository }}" >> release-body.md
          printf 'cd ~/ai-dev-atelier && git checkout v%s\n' "${{ inputs.version }}" >> release-body.md
          printf 'bash install.sh\n' >> release-body.md
          printf '\`\`\`\n\n' >> release-body.md
          printf 'Or update an existing installation:\n\n' >> release-body.md
          printf '\`\`\`bash\n' >> release-body.md
          printf 'cd ~/ai-dev-atelier\n' >> release-body.md
          printf 'git fetch --tags && git checkout v%s\n' "${{ inputs.version }}" >> release-body.md
          printf 'bash install.sh\n' >> release-body.md
          printf '\`\`\`\n' >> release-body.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_FLAG=""
          LATEST_FLAG=""
          
          # Guard --latest for gh CLI >= 2.49.2 (best-effort, with validation)
          # Extract version using grep -oE for robustness against format changes
          GH_VERSION_RAW="$(gh --version 2>/dev/null | head -1 || true)"
          GH_VERSION="$(printf '%s\n' "$GH_VERSION_RAW" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"
          
          if [ -z "$GH_VERSION" ]; then
            echo "Warning: Unable to determine gh version from: '$GH_VERSION_RAW'. Not using --latest flag." >&2
          fi
          
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
            echo "ðŸ“¦ Creating pre-release v${{ inputs.version }}..."
          else
            # Use --latest only if gh version supports it (>= 2.49.2)
            if [ -n "$GH_VERSION" ] && printf '%s\n%s\n' "2.49.2" "$GH_VERSION" | sort -V -C; then
              LATEST_FLAG="--latest"
            fi
            echo "ðŸ“¦ Creating release v${{ inputs.version }}..."
          fi
          
          # Create release with auto-generated notes
          NOTES_START=""
          if [ -n "${{ needs.validate.outputs.previous_tag }}" ]; then
            NOTES_START="--notes-start-tag ${{ needs.validate.outputs.previous_tag }}"
          fi

          # Use --notes-file to prepend clean installation notes to auto-generated PR notes
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes-file release-body.md \
            --generate-notes \
            $NOTES_START \
            $PRERELEASE_FLAG \
            $LATEST_FLAG

          echo "âœ… Release created!"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}"

      - name: Post-release summary
        run: |
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }})" >> $GITHUB_STEP_SUMMARY

  dry-run-summary:
    name: Dry Run Summary
    needs: validate
    if: ${{ inputs.dry_run == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Dry run complete
        run: |
          echo "## ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Validation passed. No release was created." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create the actual release, run:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gh workflow run release.yml -f version=${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
